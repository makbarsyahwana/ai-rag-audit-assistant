worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Logging
    log_format json_combined escape=json
        '{"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"method":"$request_method",'
        '"uri":"$request_uri",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_addr":"$upstream_addr"}';

    access_log /var/log/nginx/access.log json_combined;

    # Upstream: audit-assistant-api (multiple replicas)
    upstream api_backend {
        least_conn;
        server audit-assistant-api:8000;
    }

    # Upstream: audit-rag-engine (multiple replicas)
    upstream rag_backend {
        least_conn;
        server audit-rag-engine:8001;
    }

    server {
        listen 80;
        server_name _;

        # Health check
        location /nginx-health {
            return 200 '{"status":"ok","service":"nginx"}';
            add_header Content-Type application/json;
        }

        # API routes
        location /api/ {
            proxy_pass http://api_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 120s;
            proxy_connect_timeout 10s;
        }

        # RAG engine routes
        location /rag/ {
            proxy_pass http://rag_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;  # Longer timeout for ingestion
            proxy_connect_timeout 10s;
            client_max_body_size 100M;  # Large file uploads
        }

        # Prometheus metrics scraping (direct pass-through)
        location /api-metrics {
            proxy_pass http://api_backend/metrics;
        }

        location /rag-metrics {
            proxy_pass http://rag_backend/metrics;
        }
    }
}
